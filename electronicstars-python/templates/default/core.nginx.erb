server {
location /
{
include uwsgi_params;
uwsgi_pass unix:/tmp/core.socket;
}
location /ws/ {
proxy_http_version 1.1;
proxy_set_header Upgrade $http_upgrade;
proxy_set_header Connection "upgrade";
proxy_pass http://unix:/tmp/ws-core.socket;
}

}

<% if @application[:ssl_support] %>
    server {
    listen   443;
    server_name  <%= @application[:domains].join(" ") %> <%= node[:hostname] %>;


    ssl on;
    ssl_certificate <%= node[:nginx][:dir] %>/ssl/<%= @application[:domains].first %>.crt;
    ssl_certificate_key <%= node[:nginx][:dir] %>/ssl/<%= @application[:domains].first %>.key;
    <% if @application[:ssl_certificate_ca] -%>
        ssl_client_certificate <%= node[:nginx][:dir] %>/ssl/<%= @application[:domains].first %>.ca;
    <% end -%>

    location / {
        include uwsgi_params;
        uwsgi_pass unix:/tmp/core.socket;

    }
    location /ws/ {
    # switch off logging
    access_log off;

    # redirect all HTTP traffic to localhost:8080

    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

    # WebSocket support (nginx 1.4)
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    }
}
<% end %>